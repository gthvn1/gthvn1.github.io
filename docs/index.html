<!DOCTYPE html>
<head>
    <style>
       /* Solorized
        $base03:    #002b36;
        $base02:    #073642;
        $base01:    #586e75;
        $base00:    #657b83;
        $base0:     #839496;
        $base1:     #93a1a1;
        $base2:     #eee8d5;
        $base3:     #fdf6e3;
        $yellow:    #b58900;
        $orange:    #cb4b16;
        $red:       #dc322f;
        $magenta:   #d33682;
        $violet:    #6c71c4;
        $blue:      #268bd2;
        $cyan:      #2aa198;
        $green:     #859900;
        */

        body {
            background: #fdf6e3;
            color: #073642;
            font: Dekko, Aclonica, Abel, Verdana, sans-serif;
        }

        h1 { color: #2aa198; }
        h2 { color: #93a1a1; }

        button {
              background-color: #859900;
              color: white;
              padding: 15px 32px;
              text-align: center;
              display: inline-block;
              font-size: 16px;
        }

        .result { color: #268bd2; font-weight: bolder }
        .debug  { color: #d33682; font-style: italic }
        .checked { text-decoration: line-through; font-style: italic }
    </style>
</head>

<body>
    <h1>Let's play with Web Assembly</h1>

    <h2> Links </h2>
    <ul>
        <li><a href="https://webassembly.org/">Web Assembly</a></li>
        <li>
            <a href="https://www.youtube.com/watch?v=qEq3F9Z8z6w&t=21s">Hand-crafted WebAssembly
                Demos from Ben Smith</a>
        </li>
    </ul>

    <h2> Steps </h2>
    
    <p>
        <a href="https://github.com/gthvn1/gthvn1.github.io/blob/master/docs/fibonacci.wat">
        fibonacci.wat</a> wasm file is available
        <a href="https://github.com/gthvn1/gthvn1.github.io/tree/master/docs">on github</a>.
    </p>

    <ul>
        <li class="checked"> Wrote HTML and JS to check how they interact</li>
        <li class="checked"> Get the result from wasm</li>
        <li class="checked"> Start by implementing Fibonacci in wasm</li>
        <li class="checked"> Before looking canvas we will look how to exchange data from memory
            because it will be usefull when playing with canvas
        </li>
        <li> Look at canvas</li>
        <ul>
            <li class="checked"> Create canvas</li>
            <li class="checked"> Draw something from JS</li>
            <li> Fill the canvas from WASM</li>
            <li> ...and do more fun things</li>
        </ul>
    </ul>

    <h2> Demo </h2>
    <h3> Fibonacci Sequence </h3>
    <p class="result"> -> Fibonaci(<span id="n">0</span>) = <span id="fib">0</span> </p>
    <p class="debug">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[debug] f(<span id="a">?</span>) = <span id="fa">?</span>, f(<span id="b">?</span>) = <span id="fb">?</span></p>
    <button>
        Click to get the next Fibonacci sequence number
    </button>

    <h3> Canvas </h3>

    <canvas id="canvas" width="100" height="100" style="border:1px solid #000;">
    </canvas>

    <script>
        let bytes = new Uint8Array([
            0x00,0x61,0x73,0x6d,0x01,0x00,0x00,0x00,0x01,0x05,0x01,0x60,0x01,0x7e,0x00,0x03,0x02,0x01,0x00,0x05,0x03,0x01,0x00,0x01,0x07,0x0e,0x02,0x03,0x6d,0x65,0x6d,0x02,0x00,0x04,0x66,0x69,0x62,0x6f,0x00,0x00,0x0a,0x6c,0x01,0x6a,0x01,0x01,0x7e,0x41,0x00,0x42,0x00,0x37,0x03,0x00,0x41,0x08,0x42,0x01,0x37,0x03,0x00,0x42,0x00,0x20,0x00,0x51,0x04,0x40,0x41,0x10,0x42,0x00,0x37,0x03,0x00,0x0b,0x42,0x01,0x20,0x00,0x51,0x04,0x40,0x41,0x10,0x42,0x01,0x37,0x03,0x00,0x05,0x42,0x02,0x21,0x01,0x03,0x40,0x41,0x10,0x41,0x08,0x29,0x03,0x00,0x41,0x00,0x29,0x03,0x00,0x7c,0x37,0x03,0x00,0x41,0x00,0x41,0x08,0x29,0x03,0x00,0x37,0x03,0x00,0x41,0x08,0x41,0x10,0x29,0x03,0x00,0x37,0x03,0x00,0x20,0x01,0x42,0x01,0x7c,0x21,0x01,0x20,0x01,0x20,0x00,0x57,0x0d,0x00,0x0b,0x0b,0x0b
        ]);

        function draw_something() {
            var c = document.getElementById("canvas");
            var ctx = c.getContext("2d");
           
            // start by filling all canvas in red
            ctx.beginPath();
            ctx.rect(0,0, 100, 100);
            ctx.fillStyle = "red";
            ctx.fill();

            // Then draw triangle in green
            ctx.beginPath();
            ctx.fillStyle = "green";
            ctx.moveTo(0,0);
            ctx.lineTo(50, 100);
            ctx.stroke(); // print the line
            ctx.lineTo(100, 0);
            ctx.stroke(); // print the line
            ctx.fill();

            // Finally draw a circle in blue again...
            ctx.moveTo(70,50); // Move at the beginning of where we start to draw the circle
            // x, y, radius, start angle, end angle
            ctx.beginPath();
            ctx.fillStyle = "blue";
            ctx.arc(50, 50, 20, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.fill();
        }

        (async function start() {
            const {module, instance} = await WebAssembly.instantiate(bytes);
            const exports = instance.exports;

            draw_something();

            // In wasm memory we put 3*64bits values at the beginning.
            // So let's create a view of those 24 bytes
            let memView = new Uint8Array(exports.mem.buffer, 0x0, 24);
            let buff0 = new DataView(memView.buffer, 0x0, 8);
            let buff1 = new DataView(memView.buffer, 0x8, 8);
            let buff2 = new DataView(memView.buffer, 0x10, 8);

            let $ = document.querySelector.bind(document);
            let n = 0;

            $('button').addEventListener('click', event => {
                if (n == 0) {
                    $('#b').textContent = `${n}`
                    $('#fb').textContent = buff1.getBigInt64(0, true);
                } else {
                    $('#a').textContent = `${n - 1}`
                    $('#fa').textContent = buff0.getBigInt64(0, true);
                    $('#b').textContent = `${n}`
                    $('#fb').textContent = buff1.getBigInt64(0, true);
                }

                n++;
                $('#n').textContent = `${n}`;
                exports.fibo(BigInt(n));

                $('#fib').textContent = buff2.getBigInt64(0, true);
            });
        })();
    </script>
</body>
