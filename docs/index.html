<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="nord.css">
</head>

<body>
    <h1>Let's play with Web Assembly</h1>

    <h2> Links </h2>
    <ul>
        <li><a href="https://webassembly.org/">Web Assembly</a></li>
        <li>
            <a href="https://www.youtube.com/watch?v=qEq3F9Z8z6w&t=21s">Hand-crafted WebAssembly
                Demos from Ben Smith</a>
        </li>
    </ul>

    <h2> Steps </h2>

    <p>
        <a href="https://github.com/gthvn1/gthvn1.github.io/blob/master/docs/fibonacci.wat">
        fibonacci.wat</a> wasm file is available
        <a href="https://github.com/gthvn1/gthvn1.github.io/tree/master/docs">on github</a>.
    </p>

    <ul>
        <li> <span class="box">&#9745;</span> Wrote HTML and JS to check how they interact</li>
        <li> <span class="box">&#9745;</span> Get the result from wasm</li>
        <li> <span class="box">&#9745;</span> Start by implementing Fibonacci in wasm</li>
        <li> <span class="box">&#9745;</span> Before looking canvas we will look how to exchange data from memory
            because it will be usefull when playing with canvas
        </li>
        <li> <span class="box">&#9744;</span> Look at canvas </li>
        <ul>
            <li> <span class="box">&#9745;</span> Create canvas </li>
            <li> <span class="box">&#9745;</span> Draw something from JS </li>
            <li> <span class="box">&#9744;</span> Fill the canvas from WASM </li>
            <li> <span class="box">&#9744;</span> Add interactivity </li>
            <li> ...and do more fun things</li>
        </ul>
    </ul>

    <h2> Demo </h2>
    <h3> Fibonacci Sequence </h3>
    <p class="result"> -> Fibonaci(<span id="n">0</span>) = <span id="fib">0</span> </p>
    <p class="debug">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[debug] f(<span id="a">?</span>) = <span id="fa">?</span>, f(<span id="b">?</span>) = <span id="fb">?</span></p>
    <button>
        Click to get the next Fibonacci sequence number
    </button>

    <h3> Canvas </h3>

    <canvas id="canvas" width="100" height="100" style="border:1px solid #000;">
    </canvas>

    <script>
        function draw_something() {
            var c = document.getElementById("canvas");
            var ctx = c.getContext("2d");

            // start by filling all canvas in red
            ctx.beginPath();
            ctx.rect(0,0, 100, 100);
            ctx.fillStyle = "red";
            ctx.fill();

            // Then draw triangle in green
            ctx.beginPath();
            ctx.fillStyle = "green";
            ctx.moveTo(0,0);
            ctx.lineTo(50, 100);
            ctx.stroke(); // print the line
            ctx.lineTo(100, 0);
            ctx.stroke(); // print the line
            ctx.fill();

            // Finally draw a circle in blue
            ctx.moveTo(70,50); // Move at the beginning of where we start to draw the circle
            // x, y, radius, start angle, end angle
            ctx.beginPath();
            ctx.fillStyle = "blue";
            ctx.arc(50, 50, 20, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.fill();
        }

        (async function start() {
            const response = await fetch('fibonacci.wasm');
            const moduleBytes = await response.arrayBuffer();
            const {module, instance} = await WebAssembly.instantiate(moduleBytes);
            const exports = instance.exports;

            draw_something();

            // In wasm memory we put 3*64bits values at the beginning.
            // So let's create a view of those 24 bytes
            let memView = new Uint8Array(exports.mem.buffer, 0x0, 24);
            let buff0 = new DataView(memView.buffer, 0x0, 8);
            let buff1 = new DataView(memView.buffer, 0x8, 8);
            let buff2 = new DataView(memView.buffer, 0x10, 8);

            let $ = document.querySelector.bind(document);
            let n = 0;

            $('button').addEventListener('click', event => {
                if (n == 0) {
                    $('#b').textContent = `${n}`
                    $('#fb').textContent = buff1.getBigInt64(0, true);
                } else {
                    $('#a').textContent = `${n - 1}`
                    $('#fa').textContent = buff0.getBigInt64(0, true);
                    $('#b').textContent = `${n}`
                    $('#fb').textContent = buff1.getBigInt64(0, true);
                }

                n++;
                $('#n').textContent = `${n}`;
                exports.fibo(BigInt(n));

                $('#fib').textContent = buff2.getBigInt64(0, true);
            });
        })();
    </script>
</body>
